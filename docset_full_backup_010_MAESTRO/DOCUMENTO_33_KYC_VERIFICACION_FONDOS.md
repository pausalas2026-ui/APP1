# DOCUMENTO 33 â€“ MÃ“DULO 0.a.24 (VERSIÃ“N DEFINITIVA, PEDAGÃ“GICA Y ANTIFRAUDE)

# SISTEMA DE VERIFICACIÃ“N DE IDENTIDAD (KYC), LIBERACIÃ“N DE FONDOS, CONTROL DE FRAUDE Y PROTECCIÃ“N DE LA PLATAFORMA

---

## Documento normativo + operativo
## Documento crÃ­tico para dinero, premios y causas

**Dirigido a:** Programador IA (nivel no experto)

---

## 1. Para quÃ© existe este documento (peras y manzanas)

Este documento existe para evitar un solo problema:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚        Que salga dinero de la plataforma sin control.                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Si este documento NO se respeta, pasan cosas graves:

| Problema | Consecuencia |
|----------|--------------|
| Personas falsas cobrando | PÃ©rdida econÃ³mica directa |
| Premios no entregados | Fraude a ganadores |
| Causas inexistentes recibiendo donaciones | Fraude masivo |
| Fraudes sistemÃ¡ticos | DestrucciÃ³n de la plataforma |
| Problemas legales | Cierre forzado |
| DestrucciÃ³n de la confianza | Muerte del proyecto |

### ğŸ‘‰ Este documento define:

- âœ… **CUÃNDO** se puede entregar dinero
- âœ… **CÃ“MO** se puede entregar dinero
- âœ… **A QUIÃ‰N** se le puede entregar dinero

---

## 2. Regla madre (memorÃ­zala)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚         NADIE recibe dinero sin verificaciÃ³n previa.                   â”‚
â”‚                                                                         â”‚
â”‚                            PERO                                         â”‚
â”‚                                                                         â”‚
â”‚     NADIE estÃ¡ obligado a verificarse solo para usar la plataforma.    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Esta regla resuelve el conflicto entre:

| Objetivo | Necesidad |
|----------|-----------|
| **ConversiÃ³n / Crecimiento** | Facilitar el registro y uso |
| **Seguridad / Antifraude** | Proteger la plataforma y usuarios |

---

## 3. Por quÃ© NO se pide identificaciÃ³n al registrarse

### Explicado con peras y manzanas

Cuando una persona descarga la app:

- â“ No sabe aÃºn si le gustarÃ¡
- â“ No confÃ­a todavÃ­a
- â“ No entiende el valor
- â“ No tiene dinero pendiente

### Si en ese momento le pedimos:

- ğŸ“„ INE / DNI
- ğŸ“„ Pasaporte
- ğŸ“· Selfie

### ğŸ‘‰ SE VA.

### Por eso:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REGISTRO = SIMPLE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âœ… Se puede pagar suscripciÃ³n                                          â”‚
â”‚  âœ… Se puede crear sorteos                                              â”‚
â”‚  âœ… Se puede generar donaciones                                         â”‚
â”‚  âœ… Se puede usar todo el sistema                                       â”‚
â”‚                                                                         â”‚
â”‚  ğŸ‘‰ SIN subir identificaciÃ³n                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Estados del usuario respecto a verificaciÃ³n

Todo usuario tiene un **estado de verificaciÃ³n**.

### Estados posibles:

| Estado | CÃ³digo | DescripciÃ³n | Â¿Puede recibir dinero? |
|--------|--------|-------------|------------------------|
| **NO VERIFICADO** | `not_verified` | Estado inicial | âŒ NO |
| **VERIFICACIÃ“N PENDIENTE** | `verification_pending` | Ya iniciÃ³ KYC | âŒ NO (retenido) |
| **VERIFICADO** | `verified` | KYC aprobado | âœ… SÃ |
| **VERIFICACIÃ“N RECHAZADA** | `verification_rejected` | KYC fallido | âŒ NO |
| **VERIFICACIÃ“N EXPIRADA** | `verification_expired` | Debe renovar | âŒ NO |

### Detalle de cada estado:

#### NO VERIFICADO (`not_verified`)
- âœ… Puede usar la app
- âœ… Puede crear sorteos
- âœ… Puede generar dinero
- âŒ **No puede recibir dinero**

#### VERIFICACIÃ“N PENDIENTE (`verification_pending`)
- Ya iniciÃ³ el proceso KYC
- El dinero sigue **retenido**
- **No se libera nada**

#### VERIFICADO (`verified`)
- âœ… Puede recibir dinero
- âœ… Puede cobrar premios
- âœ… Puede liberar fondos de causas

#### VERIFICACIÃ“N RECHAZADA (`verification_rejected`)
- âŒ No recibe dinero
- âš ï¸ Puede ser bloqueado o revisado manualmente
- Puede reintentar despuÃ©s de X dÃ­as

---

## 5. Â¿CUÃNDO se pide la verificaciÃ³n? (momento exacto)

### Regla fundamental:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   La verificaciÃ³n NO se pide ANTES,                                     â”‚
â”‚   se pide SOLO cuando ocurre un EVENTO DISPARADOR.                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Eventos disparadores (cualquiera de estos):

| # | Evento | DescripciÃ³n |
|---|--------|-------------|
| 1 | **Solicitud de retiro** | El usuario solicita retirar dinero de una causa |
| 2 | **Cobro de premio** | El usuario quiere recibir dinero por un premio NO donado |
| 3 | **Primera vez** | Es la primera vez que intenta recibir dinero |
| 4 | **Umbral superado** | El monto acumulado supera un umbral (definido por negocio) |
| 5 | **Causa propia** | El usuario crea una causa propia |
| 6 | **Premio alto valor** | El usuario crea un premio de alto valor |

### Mensaje que aparece:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   "Para poder liberar los fondos, necesitamos verificar tu identidad." â”‚
â”‚                                                                         â”‚
â”‚                    [ Iniciar verificaciÃ³n ]                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. QuÃ© datos se piden en la verificaciÃ³n (Nivel 1)

### VerificaciÃ³n bÃ¡sica obligatoria (KYC Nivel 1)

#### Se solicita:

| Dato | Tipo | Obligatorio |
|------|------|-------------|
| **Documento oficial** | DNI / INE / Pasaporte | âœ… SÃ­ |
| **Selfie / Prueba de vida** | Foto en tiempo real | âœ… SÃ­ |
| **Datos bÃ¡sicos** | Nombre, fecha nacimiento | âœ… SÃ­ |

#### Esto sirve para:

- âœ… Confirmar que la persona **existe**
- âœ… Asociar **legalmente** responsabilidades
- âœ… Evitar **identidades falsas**

### Regla inquebrantable:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚           ğŸ‘‰ Sin KYC Nivel 1, NO hay liberaciÃ³n de dinero              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. VerificaciÃ³n reforzada (Nivel 2 â€“ solo en algunos casos)

### Â¿CuÃ¡ndo se activa Nivel 2?

| CondiciÃ³n | Umbral sugerido |
|-----------|-----------------|
| **Montos altos** | > $1,000 USD acumulado |
| **Causas creadas por usuario** | Siempre |
| **Premios de alto valor** | > $500 USD valor estimado |
| **SeÃ±ales de riesgo** | Flags del sistema antifraude |

### QuÃ© puede incluir Nivel 2:

| VerificaciÃ³n adicional | DescripciÃ³n |
|------------------------|-------------|
| Documento adicional | Comprobante de domicilio |
| ValidaciÃ³n manual | RevisiÃ³n por equipo humano |
| Contacto directo | Llamada o videollamada |
| ConfirmaciÃ³n externa | Verificar con fundaciÃ³n (si es causa) |

### Importante:

ğŸ‘‰ **NO todos los usuarios pasan por Nivel 2.**  
Solo los que cumplen las condiciones.

---

## 8. RelaciÃ³n entre verificaciÃ³n y premios (muy importante)

### Caso A â€“ Usuario DONA el premio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CASO A: PREMIO DONADO                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â€¢ No recibe dinero por el premio                                       â”‚
â”‚  â€¢ Solo debe:                                                           â”‚
â”‚    - Entregar el premio                                                 â”‚
â”‚    - Subir evidencia                                                    â”‚
â”‚                                                                         â”‚
â”‚  VerificaciÃ³n:                                                          â”‚
â”‚  â€¢ Puede ser mÃ¡s simple                                                 â”‚
â”‚  â€¢ PERO sigue siendo requerida si hay dinero por causa                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Caso B â€“ Usuario NO dona el premio y quiere cobrar su valor

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CASO B: PREMIO CON COBRO DE VALOR                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Flujo con peras y manzanas:                                            â”‚
â”‚                                                                         â”‚
â”‚  1. Se ejecuta el sorteo                                                â”‚
â”‚           â†“                                                             â”‚
â”‚  2. Hay un ganador                                                      â”‚
â”‚           â†“                                                             â”‚
â”‚  3. El usuario entrega el premio                                        â”‚
â”‚           â†“                                                             â”‚
â”‚  4. El usuario sube:                                                    â”‚
â”‚     â€¢ Fotos de entrega                                                  â”‚
â”‚     â€¢ Datos del ganador                                                 â”‚
â”‚           â†“                                                             â”‚
â”‚  5. La plataforma verifica con el ganador                               â”‚
â”‚           â†“                                                             â”‚
â”‚  6. SOLO DESPUÃ‰S:                                                       â”‚
â”‚     â€¢ Se pide o valida KYC                                              â”‚
â”‚     â€¢ Se libera el dinero                                               â”‚
â”‚                                                                         â”‚
â”‚  ğŸ‘‰ NUNCA al revÃ©s                                                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. RelaciÃ³n entre verificaciÃ³n y causas propias

### Si el usuario crea una causa propia:

| Requisito | DescripciÃ³n |
|-----------|-------------|
| **Acreditar existencia** | Debe demostrar que la causa existe |
| **Verificarse como persona** | KYC obligatorio |
| **Dinero retenido** | Hasta que todo estÃ© validado |

### Flujo completo:

```
Usuario crea causa propia
        â†“
Sube documentaciÃ³n de causa
        â†“
Plataforma revisa causa
        â†“
Usuario inicia KYC (si no lo ha hecho)
        â†“
Causa aprobada + KYC aprobado
        â†“
Dinero puede ser liberado
```

### Regla:

ğŸ‘‰ **Esto evita causas falsas.**

---

## 10. QuÃ© pasa si el usuario NO quiere verificarse

### Explicado claro:

| AcciÃ³n | Â¿Permitida? |
|--------|-------------|
| Seguir usando la app | âœ… SÃ |
| Seguir pagando su plan | âœ… SÃ |
| Seguir haciendo sorteos | âœ… SÃ |
| Seguir generando impacto | âœ… SÃ |
| **Recibir dinero** | âŒ NO |

### Esto:

- âŒ **NO** es motivo de cancelaciÃ³n forzada
- âŒ **NO** bloquea la app
- âŒ **NO** castiga al usuario
- âœ… Es simplemente una **regla de seguridad**

---

## 11. Â¿Proveedor externo o sistema propio?

### RecomendaciÃ³n firme:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   1. Usar PROVEEDOR EXTERNO de KYC al inicio                           â”‚
â”‚   2. DiseÃ±ar una CAPA ABSTRACTA de verificaciÃ³n                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ventajas de proveedor externo:

| Ventaja | DescripciÃ³n |
|---------|-------------|
| **Menos riesgo legal** | El proveedor asume responsabilidades |
| **Menos desarrollo** | No reinventar la rueda |
| **MÃ¡s seguridad** | Especialistas en el tema |
| **Cumplimiento normativo** | Proveedores ya cumplen regulaciones |

### Proveedores sugeridos (referencia):

| Proveedor | CaracterÃ­sticas |
|-----------|-----------------|
| **Onfido** | Global, robusto |
| **Jumio** | VerificaciÃ³n de documentos |
| **Veriff** | FÃ¡cil integraciÃ³n |
| **Truora** | LatinoamÃ©rica |
| **Stripe Identity** | Si ya usas Stripe |

### Arquitectura recomendada:

```typescript
// Capa abstracta - permite cambiar proveedor
interface KYCProvider {
  startVerification(userId: string): Promise<VerificationSession>;
  checkStatus(sessionId: string): Promise<VerificationStatus>;
  getResult(sessionId: string): Promise<VerificationResult>;
}

// Implementaciones
class OnfidoProvider implements KYCProvider { ... }
class JumioProvider implements KYCProvider { ... }
class ManualProvider implements KYCProvider { ... } // Fallback
```

ğŸ‘‰ **El sistema debe permitir cambiar de proveedor en el futuro.**

---

## 12. Estados del dinero (muy importante para backend)

### Todo dinero debe tener estado:

| Estado | CÃ³digo | DescripciÃ³n |
|--------|--------|-------------|
| **GENERADO** | `generated` | Dinero creado por transacciÃ³n |
| **RETENIDO** | `held` | Esperando verificaciones |
| **PENDIENTE DE VERIFICACIÃ“N** | `pending_verification` | Usuario debe completar KYC |
| **APROBADO** | `approved` | Listo para liberar |
| **LIBERADO** | `released` | Transferido al usuario |
| **RECHAZADO** | `rejected` | No se puede liberar |
| **BLOQUEADO** | `blocked` | Fraude detectado |

### Diagrama de estados:

```
GENERADO â†’ RETENIDO â†’ PENDIENTE_VERIFICACIÃ“N â†’ APROBADO â†’ LIBERADO
                                            â†˜ RECHAZADO
                                            â†˜ BLOQUEADO
```

### Regla crÃ­tica:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚               ğŸ‘‰ NUNCA saltar estados                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. Checklist obligatorio antes de liberar dinero

### Antes de liberar fondos, el sistema debe validar:

| # | ValidaciÃ³n | DescripciÃ³n |
|---|------------|-------------|
| 1 | â˜ Usuario verificado | KYC Nivel 1 aprobado |
| 2 | â˜ Premio entregado | Si aplica, evidencia verificada |
| 3 | â˜ Evidencia subida | Fotos de entrega |
| 4 | â˜ Ganador confirmado | Contacto con ganador exitoso |
| 5 | â˜ Causa verificada | Si es causa propia |
| 6 | â˜ No hay flags de fraude | Sistema antifraude OK |

### Regla:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚        Si ALGO falla â†’ NO liberar dinero                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. Mensaje UX correcto (muy importante)

### âŒ NO decir:

```
"Debes verificarte para usar la app."
```

### âœ… SÃ decir:

```
"Para liberar fondos, necesitamos verificar tu identidad."
```

### Â¿Por quÃ© importa?

| Mensaje incorrecto | Mensaje correcto |
|-------------------|------------------|
| Genera abandono | Genera confianza |
| Parece obligaciÃ³n | Parece protecciÃ³n |
| Frustra al usuario | Informa al usuario |

### Mensajes UX recomendados:

| Momento | Mensaje |
|---------|---------|
| **Al generar dinero** | "Â¡Felicidades! Has generado $X. Para retirarlo, necesitarÃ¡s verificar tu identidad." |
| **Al solicitar retiro** | "Para proteger tus fondos y los de las causas, necesitamos verificar tu identidad." |
| **KYC en proceso** | "Estamos verificando tu identidad. Te avisaremos cuando estÃ© listo." |
| **KYC aprobado** | "Â¡VerificaciÃ³n completada! Ya puedes retirar tus fondos." |
| **KYC rechazado** | "No pudimos verificar tu identidad. Puedes intentarlo de nuevo en X dÃ­as." |

---

## 15. Modelo de Datos

### Tabla: `user_verifications`

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| id | UUID | Identificador Ãºnico |
| user_id | UUID | FK al usuario |
| status | enum | 'not_verified', 'pending', 'verified', 'rejected', 'expired' |
| level | enum | 'level_1', 'level_2' |
| provider | varchar | Proveedor KYC usado |
| provider_session_id | varchar | ID de sesiÃ³n del proveedor |
| provider_response | jsonb | Respuesta completa del proveedor |
| document_type | varchar | Tipo de documento verificado |
| document_country | varchar | PaÃ­s del documento |
| verified_name | varchar | Nombre verificado |
| verified_dob | date | Fecha de nacimiento verificada |
| rejection_reason | text | RazÃ³n de rechazo |
| attempts | integer | Intentos de verificaciÃ³n |
| last_attempt_at | datetime | Ãšltimo intento |
| verified_at | datetime | Fecha de verificaciÃ³n exitosa |
| expires_at | datetime | Fecha de expiraciÃ³n |
| created_at | datetime | Auto |
| updated_at | datetime | Auto |

### Tabla: `fund_states`

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| id | UUID | Identificador Ãºnico |
| user_id | UUID | FK al usuario |
| source_type | enum | 'sweepstake', 'cause', 'prize' |
| source_id | UUID | FK a la fuente |
| amount | decimal | Monto |
| currency | varchar | Moneda |
| status | enum | 'generated', 'held', 'pending_verification', 'approved', 'released', 'rejected', 'blocked' |
| held_reason | text | RazÃ³n de retenciÃ³n |
| release_conditions | jsonb | Condiciones para liberar |
| released_at | datetime | Fecha de liberaciÃ³n |
| released_to | varchar | Destino de fondos |
| transaction_id | varchar | ID de transacciÃ³n bancaria |
| created_at | datetime | Auto |
| updated_at | datetime | Auto |

### Tabla: `verification_triggers`

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| id | UUID | Identificador Ãºnico |
| user_id | UUID | FK al usuario |
| trigger_type | enum | 'withdrawal_request', 'prize_payment', 'threshold_reached', 'cause_creation', 'high_value_prize' |
| trigger_amount | decimal | Monto que disparÃ³ |
| trigger_source_id | UUID | ID del recurso que disparÃ³ |
| verification_required_level | enum | 'level_1', 'level_2' |
| created_at | datetime | Auto |

### Tabla: `kyc_audit_log`

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| id | UUID | Identificador Ãºnico |
| user_id | UUID | FK al usuario |
| action | varchar | AcciÃ³n realizada |
| previous_status | varchar | Estado anterior |
| new_status | varchar | Estado nuevo |
| actor_id | UUID | Quien realizÃ³ la acciÃ³n |
| actor_type | enum | 'system', 'user', 'admin', 'provider' |
| metadata | jsonb | Datos adicionales |
| ip_address | varchar | IP |
| created_at | datetime | Auto |

---

## 16. API Endpoints

### VerificaciÃ³n de Usuario

```
GET    /verification/status                 # Estado de verificaciÃ³n del usuario
POST   /verification/start                  # Iniciar proceso KYC
POST   /verification/upload-document        # Subir documento
POST   /verification/upload-selfie          # Subir selfie
GET    /verification/session/:id            # Estado de sesiÃ³n KYC
POST   /verification/webhook                # Webhook del proveedor KYC
```

### Fondos y Retiros

```
GET    /funds/balance                       # Balance disponible y retenido
GET    /funds/history                       # Historial de fondos
POST   /funds/request-withdrawal            # Solicitar retiro
GET    /funds/withdrawal/:id                # Estado de retiro
GET    /funds/requirements                  # Requisitos para liberar fondos
```

### Admin

```
GET    /admin/verifications/pending         # Verificaciones pendientes
POST   /admin/verifications/:id/approve     # Aprobar manualmente
POST   /admin/verifications/:id/reject      # Rechazar manualmente
GET    /admin/funds/held                    # Fondos retenidos
POST   /admin/funds/:id/release             # Liberar fondos manualmente
POST   /admin/funds/:id/block               # Bloquear fondos
GET    /admin/kyc-audit/:userId             # AuditorÃ­a KYC de usuario
```

---

## 17. ImplementaciÃ³n de Referencia

### Servicio de VerificaciÃ³n

```typescript
class VerificationService {
  
  async checkIfVerificationRequired(userId: string, action: TriggerType): Promise<boolean> {
    const user = await this.userRepo.findById(userId);
    
    // Si ya estÃ¡ verificado, no se requiere
    if (user.verification_status === 'verified') {
      return false;
    }
    
    // Verificar si la acciÃ³n requiere KYC
    const triggers = ['withdrawal_request', 'prize_payment', 'cause_creation'];
    if (triggers.includes(action)) {
      return true;
    }
    
    // Verificar umbral de monto
    const pendingFunds = await this.fundsRepo.getPendingAmount(userId);
    const threshold = await this.settingsRepo.get('kyc_threshold_amount');
    
    if (pendingFunds >= threshold) {
      return true;
    }
    
    return false;
  }
  
  async startVerification(userId: string, level: 'level_1' | 'level_2'): Promise<VerificationSession> {
    // Crear sesiÃ³n con proveedor externo
    const session = await this.kycProvider.startVerification(userId);
    
    // Guardar en BD
    await this.verificationRepo.create({
      user_id: userId,
      status: 'pending',
      level,
      provider: this.kycProvider.name,
      provider_session_id: session.id
    });
    
    // Log de auditorÃ­a
    await this.auditLog.log({
      user_id: userId,
      action: 'KYC_STARTED',
      new_status: 'pending',
      metadata: { level, provider: this.kycProvider.name }
    });
    
    return session;
  }
  
  async processProviderWebhook(payload: ProviderWebhook): Promise<void> {
    const verification = await this.verificationRepo.findByProviderSession(payload.session_id);
    
    if (payload.status === 'approved') {
      await this.approveVerification(verification.id, payload);
    } else if (payload.status === 'rejected') {
      await this.rejectVerification(verification.id, payload.reason);
    }
  }
  
  async approveVerification(verificationId: string, data: ProviderResult): Promise<void> {
    const verification = await this.verificationRepo.findById(verificationId);
    
    await this.verificationRepo.update(verificationId, {
      status: 'verified',
      verified_name: data.name,
      verified_dob: data.date_of_birth,
      document_type: data.document_type,
      document_country: data.country,
      verified_at: new Date(),
      provider_response: data
    });
    
    // Actualizar usuario
    await this.userRepo.update(verification.user_id, {
      verification_status: 'verified'
    });
    
    // Procesar fondos pendientes
    await this.fundsService.processVerifiedUser(verification.user_id);
    
    // Notificar
    await this.notificationService.send(verification.user_id, 'KYC_APPROVED');
    
    // AuditorÃ­a
    await this.auditLog.log({
      user_id: verification.user_id,
      action: 'KYC_APPROVED',
      previous_status: 'pending',
      new_status: 'verified'
    });
  }
}
```

### Servicio de Fondos

```typescript
class FundsService {
  
  async canReleaseFunds(fundId: string): Promise<{ canRelease: boolean; blockers: string[] }> {
    const fund = await this.fundsRepo.findById(fundId);
    const user = await this.userRepo.findById(fund.user_id);
    const blockers: string[] = [];
    
    // 1. Usuario verificado
    if (user.verification_status !== 'verified') {
      blockers.push('USER_NOT_VERIFIED');
    }
    
    // 2. Si es premio, verificar entrega
    if (fund.source_type === 'prize') {
      const delivery = await this.deliveryRepo.findByPrize(fund.source_id);
      if (delivery.delivery_status !== 'verified') {
        blockers.push('PRIZE_NOT_DELIVERED');
      }
    }
    
    // 3. Si es causa propia, verificar causa
    if (fund.source_type === 'cause') {
      const cause = await this.causeRepo.findById(fund.source_id);
      if (cause.verification_status !== 'approved') {
        blockers.push('CAUSE_NOT_VERIFIED');
      }
    }
    
    // 4. Verificar flags de fraude
    const fraudCheck = await this.antifraudService.check(fund.user_id);
    if (fraudCheck.hasFlags) {
      blockers.push('FRAUD_FLAGS_DETECTED');
    }
    
    return {
      canRelease: blockers.length === 0,
      blockers
    };
  }
  
  async releaseFunds(fundId: string): Promise<void> {
    const { canRelease, blockers } = await this.canReleaseFunds(fundId);
    
    if (!canRelease) {
      throw new BusinessError('CANNOT_RELEASE_FUNDS', { blockers });
    }
    
    const fund = await this.fundsRepo.findById(fundId);
    
    // Actualizar estado
    await this.fundsRepo.update(fundId, {
      status: 'approved'
    });
    
    // Procesar pago
    const transaction = await this.paymentService.transfer(
      fund.user_id,
      fund.amount,
      fund.currency
    );
    
    // Marcar como liberado
    await this.fundsRepo.update(fundId, {
      status: 'released',
      released_at: new Date(),
      transaction_id: transaction.id
    });
    
    // AuditorÃ­a
    await this.auditLog.log({
      action: 'FUNDS_RELEASED',
      fund_id: fundId,
      amount: fund.amount,
      user_id: fund.user_id
    });
  }
}
```

---

## 18. ConfiguraciÃ³n Admin

### Settings requeridos:

```sql
INSERT INTO settings (key, value, category) VALUES
-- Umbrales KYC
('kyc_threshold_amount', '100', 'kyc'),
('kyc_high_value_prize_threshold', '500', 'kyc'),
('kyc_level2_threshold', '1000', 'kyc'),

-- Reintentos
('kyc_max_attempts', '3', 'kyc'),
('kyc_retry_cooldown_days', '7', 'kyc'),
('kyc_expiration_days', '365', 'kyc'),

-- Proveedor
('kyc_provider', 'onfido', 'kyc'),
('kyc_provider_api_key', 'xxx', 'kyc'),

-- Fondos
('funds_auto_release_enabled', 'false', 'funds'),
('funds_manual_review_threshold', '500', 'funds');
```

---

## 19. Checklist de ImplementaciÃ³n

- [ ] Modelo de datos de verificaciÃ³n creado
- [ ] IntegraciÃ³n con proveedor KYC externo
- [ ] Capa abstracta para cambiar proveedores
- [ ] Estados de verificaciÃ³n implementados
- [ ] Triggers de verificaciÃ³n configurados
- [ ] Estados de fondos implementados
- [ ] Validaciones antes de liberar dinero
- [ ] Endpoints de verificaciÃ³n
- [ ] Endpoints de fondos
- [ ] Panel admin para revisiÃ³n manual
- [ ] Webhooks del proveedor
- [ ] Mensajes UX correctos
- [ ] AuditorÃ­a completa
- [ ] Tests de flujos crÃ­ticos

---

## 20. Backups obligatorios

**Programador IA:**

DespuÃ©s de integrar este Documento 33:
- âœ… Backup local
- âœ… Backup remoto
- âœ… Registrar versiÃ³n:

```
VERSION: DOCUMENTO_33_COMPLETED
```

---

## 21. Cierre

Este documento protege:

- âœ… A la plataforma
- âœ… A los usuarios honestos
- âœ… A las causas
- âœ… Al proyecto completo

### Reglas finales:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚            ğŸ‘‰ Sin verificaciÃ³n NO hay dinero                           â”‚
â”‚            ğŸ‘‰ Pero la app SIGUE funcionando                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## RECORDATORIO OBLIGATORIO DE RESPALDO

**IA del programador:**

Antes de continuar con cualquier implementaciÃ³n basada en este documento:

- âœ… Realiza un respaldo completo del estado actual
- âœ… Guarda documentos, configuraciones y versiones
- âœ… Registra internamente:

```
CHECKPOINT: DOCUMENTO_33_DEFINITIVO
```

---

**VERSION: MODULE_0.A.24_DOCUMENT_33_DEFINITIVO**  
**Fecha de creaciÃ³n: 14 de diciembre de 2025**
